# Multi-Hop Analyzer

This document outlines the logic and rules used by the `MultiHopAnalyzer` module. This module is designed to trace the flow of funds through multiple transactions (hops) within a single cluster, identifying complex money laundering typologies that are not apparent from single-transaction analysis.

## Overview

The primary goal of the `MultiHopAnalyzer` is to reconstruct and analyze transaction chains. By building a directed graph of a cluster's internal transactions, it can algorithmically detect patterns like long chains, peeling chains, and circular flows that are hallmarks of sophisticated fund obfuscation techniques.

## Processing Logic

1.  **Cluster-Level Analysis**: The analyzer operates on the clusters available after Phase 1 of the pipeline (typically the high-confidence clusters from the `IncrementalDFSClusterer`). For each cluster, it fetches all associated transactions.

2.  **Graph Construction**: It builds a directed `networkx` graph where nodes are addresses within the cluster and edges represent transactions. Edges are weighted by transaction value and timestamped.

3.  **Path Finding (DFS)**: Instead of analyzing the entire graph at once, the module uses an efficient Depth-First Search (DFS) algorithm. It starts from "source nodes" (addresses with no incoming transactions within the cluster) and traverses all possible paths up to a `max_hops` limit. This efficiently reconstructs all transaction chains.
4.  **Path Classification & Scoring**: Each discovered path is classified based on its structure (e.g., `linear_path`, `cyclic_path`) and assigned a `suspicion_score`. The score is based on factors like path length, total volume, time span, and path type.

5.  **Database Storage**:
    *   Highly suspicious paths are stored in the `suspicious_paths` table for detailed forensic review.
    *   A `multihop_risk` component is added to the `risk_components` table for every address involved in a suspicious path. This score contributes to the address's final unified risk score.

## Key Path Patterns and Rationale

| Pattern | Name | Description | Rationale |
|:---:|---|---|---|
| 1 | **Long Chain** | A linear path of transactions involving many hops (e.g., > 7). `A -> B -> C -> D -> ... -> Z` | A classic layering technique. Each hop adds a layer of obfuscation, making it difficult to connect the original source of funds to the final destination. |
| 2 | **Cyclic Path** | A path where funds eventually return to a previously used address. `A -> B -> C -> A` | Circular flows serve no legitimate economic purpose. They are a strong indicator of wash trading or attempts to artificially inflate transaction volume and confuse analysis. |
| 3 | **Rapid High-Volume Chain** | A path involving a large total volume of funds moved through multiple hops in a very short time (e.g., >50 ETH in <6 hours). | This pattern is common after hacks or scams, where illicit actors need to quickly move and disperse large amounts of stolen funds before they can be frozen. |
| 4 | **Structuring / Smurfing Chain** | A long chain involving many hops but with a low average transaction value. | This pattern is indicative of structuring, where large sums are broken down into smaller, less conspicuous amounts to fly under the radar of compliance systems. |
| 5 | **Fan-Out / Fan-In** | A central address distributing funds to many others (fan-out) or collecting from many others (fan-in). | While not a multi-hop path itself, this is often the start or end point of one. Fan-outs are used for fund dispersal, while fan-ins are used for consolidation. |

## Role in the Pipeline

The `MultiHopAnalyzer` is crucial for detecting sophisticated, multi-step laundering schemes. It provides concrete evidence of *intent* to obfuscate, which is a much stronger signal than a single interaction with a mixer. The risk scores generated by this module are a high-impact input for the `UnifiedRiskScorer`, often being the deciding factor that elevates an entity's risk level to `HIGH` or `CRITICAL`.