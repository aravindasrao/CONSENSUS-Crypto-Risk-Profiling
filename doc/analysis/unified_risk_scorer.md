# Unified Risk Scorer

This document outlines the logic and methodology used by the `UnifiedRiskScorer` module. This module is the final and most critical component of the risk assessment pipeline, responsible for aggregating all risk signals from every analysis module into a single, normalized, and explainable risk score for each address and cluster.

## Overview

An address can be flagged for risk by multiple analyzers for different reasons (e.g., mixer usage, suspicious flow patterns, GNN anomaly). The `UnifiedRiskScorer` takes all these individual "risk components" and combines them using a weighted, evidence-based formula. This produces a holistic score that reflects the totality of an entity's on-chain behavior.

## Processing Logic

1.  **Evidence Ingestion**: The scorer queries the `risk_components` table to fetch all risk signals generated by the entire pipeline for every address.

2.  **Weighted Summation**: For each address, it calculates a raw risk score by summing the scores of all its components, each multiplied by a predefined weight.
    `Raw Score = Î£ (component_score * component_weight * component_confidence)`

3.  **Non-Linear Scaling (Sigmoid Activation)**: The raw score is passed through a sigmoid activation function to produce the final score between 0.0 and 1.0. This ensures:
    *   **Diminishing Returns**: Multiple low-risk signals will increase the score, but not as much as a single high-risk signal.
    *   **High-Impact Events**: A component with a weight of 1.0 or higher (like interacting with a sanctioned entity) can push the score directly to the maximum, regardless of other factors.

4.  **Cluster-Level Propagation**: The final risk score is propagated across clusters. The risk score for a cluster is defined as the **maximum risk score** of any address within that cluster. This score is then applied to all addresses belonging to that cluster, ensuring that risk is shared among all addresses controlled by the same entity. This step is handled after all individual scores are calculated.

5.  **Database Storage**: The final, unified risk score is stored in the `final_risk_score` column of the `addresses` table.

## Evidence Weights

The weights are the core of the scoring logic, reflecting the forensic significance of each type of evidence.

| Component Type | Source Analyzer | Default Weight | Rationale |
|:---:|---|:---:|---|
| `foundation_risk` | `FoundationLayer` | **0.2** | A baseline score derived from basic features. It's a weak signal on its own. |
| `TORNADO_CASH_INTERACTION` | `TornadoInteractionAnalyzer` | **0.8** | Direct interaction with a known mixer is a strong indicator of privacy-seeking or illicit behavior. |
| `PEELING_CHAIN_DETECTED` | `FlowAnalyzer` | **0.9** | This is a classic, deliberate money laundering typology. Very high confidence. |
| `STRUCTURING_DETECTED` | `FlowAnalyzer` | **0.9** | Another textbook money laundering pattern designed to evade detection. |
| `multihop_risk` | `MultiHopAnalyzer` | **0.85** | Evidence of layering or complex obfuscation is a strong signal of intent. |
| `network_topology` | `NetworkAnalyzer` | **0.6** | Suspicious internal cluster structure (e.g., cycles) is a good indicator of non-standard fund management. |
| `gnn_risk` | `GraphTransformerNetwork` | **0.7** | An anomaly score from an advanced GNN indicates behavior that is structurally unusual. |
| `graphsage_risk` | `GraphSAGEAnalyzer` | **0.65** | A risk signal from a supervised model trained to find patterns similar to known high-risk actors. |
| `hgn_risk` | `HGNAnalyzer` | **0.7** | A risk signal from a model that understands the different roles of EOAs and contracts. |
| `temporal_gnn_risk` | `TemporalGNNAnalyzer` | **0.75** | Detects coordinated activity or sudden behavioral changes, which are often linked to illicit events. |
| `ANOMALY_DETECTED` | `EnhancedAnomalyDetector` | **0.5** | A general "catch-all" for outlier behavior. It's a moderate signal that warrants review. |
| `BEHAVIORAL_SEQUENCE` | `AdvancedBehavioralSequenceMiner` | **0.85** | Finding a known illicit TTP (e.g., automated deposit/dispersal) is strong evidence of intent. |
| `DEPOSIT_WITHDRAWAL_ANOMALY` | `DepositWithdrawalPatternAnalyzer` | **0.8** | Machine-like timing or immediate pass-through behavior is a strong indicator of automated laundering. |
| `CROSS_CHAIN_RISK_PROPAGATION` | `CrossChainAnalyzer` | **1.0** | If an entity is high-risk on one chain, that risk is considered absolute and propagates fully to all other chains. |
| `ZK_PROOF_VULNERABILITY` | `ZKProofAnalyzer` | **1.0** | A cryptographic vulnerability like a double-spend is a critical, non-behavioral flaw that represents maximum risk. |

## Role in the Pipeline

The `UnifiedRiskScorer` is the final step of the analysis phase. It synthesizes weeks or months of complex on-chain activity, analyzed by over a dozen specialized modules, into a single, actionable number. This final score is the primary metric used in the `ForensicExporter` for reports, visualizations, and prioritizing entities for manual investigation.